<div class="container-fluid purchase">
    <div class="container">
        <h3>CUSTOMER PRODUCT PURCHASING</h3>
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">LIST OF PRODUCTS INFORMATION</div>
                    <div class="panel-body">
                        <div class="table-wrapper">
                            <table class="table table-striped table-hover table-responsive" id="ordered_items" style="min-width: 1100px;">
                                <thead>
                                    <tr>
                                        <td>BOX/ITEM NO</td>
                                        <td>ITEMS</td>
                                        <td>BRAND</td>
                                        <td>SIZE</td>
                                        <td>COLOR</td>
                                        <td>PRICE</td>
                                        <td>ACTION</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php if(!empty($products)): ?>
                                        <?php foreach($products as $row => $prod): ?>
                                            <tr>
                                                <td class="box_num<?= $prod->id; ?>" id="<?= $prod->item_box_num; ?>">
                                                    <div class="check<?= $prod->id; ?>" style="display: inline-table; visibility: hidden;">
                                                        <img class="image" src="<?= base_url(); ?>src/img/check.png" alt="" style="height: 20px; width: 20px;">
                                                    </div>
                                                    <?= $prod->item_box_num; ?>
                                                </td>
                                                <td>
                                                    <div style="height: 50px; width: 50px; overflow: hidden; display: inline-table; background-color: #fff; border: 1px solid #8ea1ac; border-radius: 3px;">
                                                        <img src="<?= base_url(); ?>uploads/<?= $prod->image_name; ?>" srcset="" style="height: auto; width: 50px;">
                                                    </div>
                                                    <?= $prod->item_desc; ?>
                                                </td>
                                                <td>
                                                    <?= $prod->brand; ?>
                                                </td>
                                                <td><?= $prod->size; ?></td>
                                                <td><?= $prod->color; ?></td>
                                                <td class="price<?= $prod->id; ?>" id="<?= $prod->price; ?>"><?= $prod->price; ?></td>
                                                <td>
                                                    <button id="<?= $prod->id; ?>" class="btn btn-danger btn-sm select">SELECT</button>
                                                </td>
                                            </tr>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-8"> 
                <div class="row">
                    <div class="col-md-8 col-sm-6">
                        <div class="form-group">
                            <label id='search'>Search customer...</label>
                            <input type="text" class="form-control" name="search_customer">
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <!-- <button class="btn btn-info" name="search"><i class="fa fa-search"></i> SEARCH</button> -->
                    </div>
                </div>
            </div>
            <div class="col-md-4"></div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">CUSTOMER INFORMATION</div>
                    <div class="panel-body">
                        <div class="row">
                            <input type="hidden" name="customer_id">
                            <div class="col-md-6">
                                <h5>FULL NAME : <span id="name"></span></h5>
                            </div>
                            <div class="col-md-6">
                                <h5>NICK NAME : <span id="n_name"></span></h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <h5>PROFESSION / BUSINESS : <span id="business"></span></h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h5>COLOR : <span id="color"></span></h5>
                            </div>
                            <div class="col-md-6">
                                <h5>SIZE : <span id="size"></span></h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <h5>ADDRESS : <span id="address"></span></h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <h5>CONTACT NO : <span id="contact"></span></h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <a href="" class="btn btn-info update customer">UPDATE INFO</a>
                                <button id="purchase" class="btn btn-info purchase">PURCHASE</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- <div class="row">
            <div class="col-md-8"> 
                <div class="row">
                    <div class="col-md-8 col-sm-6">
                        <div class="form-group">
                            <label>Search product...</label>
                            <input type="text" class="form-control" name="search_product">
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <button class="btn btn-info" name="search"><i class="fa fa-search"></i> SEARCH</button>
                    </div>
                </div>
            </div>
            <div class="col-md-4"></div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">PRODUCT INFORMATION</div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-5">
                                <input type="hidden" name="product_id">
                                <div class="row" style="margin-top: 25px;">
                                    <div class="col-md-12">
                                        <h5>BOX / ITEM NO : <span id="box_num"></span></h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <h5>ITEM : <span id="item"></span></h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <h5>BRAND : <span id="brand"></span></h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <h5>SIZE : <span id="prod_size"></span></h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <h5>COLOR : <span id="prod_color"></span></h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <h5>PRICE (Php) : <span id="price"></span></h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <a href="#" class="btn btn-default clear">VIEW PRODUCTS</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <div class="row" style="margin-top: -15px;">
                                    <div class="col-md-6 col-sm-8">
                                        <div class="form-group">
                                            <label id="user">Remarks</label>
                                            <input type="text" class="form-control ln" name="remarks" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" style="margin-top: 20px;">
                                    <div class="col-md-12">
                                        <button class="btn btn-info purchase" id="purchase">PURCHASE</button>
                                        <a href="" class="btn btn-info update" id='product'>UPDATE</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> -->
    </div>
</div>
<script>
    $(document).ready(function(){

        $('#ordered_items').DataTable()

        var id = [], box_num = [], price = [];
        $('.select').on('click', function(){
            if($(this).text() == 'SELECT'){
                $(this).text('UNSELECT');
                $('.check' + $(this).attr('id')).css('visibility', 'visible');
                id.push($(this).attr('id'));
                box_num.push($('.box_num' + $(this).attr('id')).attr('id'));
                price.push($('.price' + $(this).attr('id')).attr('id'));
            }
            else if($(this).text() == 'UNSELECT'){
                $(this).text('SELECT');
                $('.check' + $(this).attr('id')).css('visibility', 'hidden');
                for (let index = 0; index < id.length; index++) {
                    if(id[index] == $(this).attr('id')){
                        box_num.splice(index, 1);
                        id.splice(index, 1);
                        price.splice(index, 1);
                    }
                }
            }
        })

        $('input[name="search_customer"]').on('blur', function(){
            if($(this).val() != ''){
                $.ajax({
                    url: '<?= base_url(); ?>user/get_customer_info',
                    type: 'POST',
                    data: {customer: $(this).val() },
                    success: function(data){
                        const log_oObj = JSON.parse(data);
                        console.log(log_oObj);
                        log_oObj.forEach(element => {
                            $('input[name="customer_id"]').val(element['id']);
                            $('#name').html(element['name']);
                            $('#n_name').html(element['nick_name']);
                            $('#business').html(element['profession_business']);
                            $('#color').html(element['color']);
                            $('#size').html(element['size']);
                            $('#address').html(element['address']);
                            $('#contact').html(element['contact']);
                            $('.customer').prop('href', '<?= base_url(); ?>page/form/update-customer.html/'+ element['id'] +'/update-info')
                        });
                    }
                })
            }
        })

        $('#purchase').click(function(){
            if($('input[name="customer_id"]').val() != ''){
                $.ajax({
                    url: '<?= base_url(); ?>user/save_order',
                    type: 'POST',
                    data: {
                        id          : id,
                        customer_id : $('input[name="customer_id"]').val(),
                        price       : price,
                        item_box_num: box_num,
                        remarks     : 'Sold and Delivered'
                    },
                    success: function(data){
                        const log_oObj = JSON.parse(data);
                        console.log(log_oObj);
                        if(log_oObj.insert == true){
                            swal(
                                {
                                    title: 'SUCCESSFUL',
                                    text : log_oObj.message,
                                    type : "success",
                                    showCancelButton  : false,
                                    showConfirmButton  : false,
                                    confirmButtonColor: "#A5DC86",
                                    confirmButtonText : "OK",
                                    cancelButtonText  : "",
                                    closeOnConfirm    : true,
                                    closeOnCancel     : false 
                                }
                            );
                            setTimeout(() => {
                                document.location.href = "<?= base_url(); ?>page/view/purchase.html";
                            }, 1500);
                        }
                        else{
                            swal(
                                {
                                    title: "ERROR",
                                    text : log_oObj.message,
                                    type : "error",
                                    showCancelButton  : false,
                                    confirmButtonColor: "#F27474",
                                    confirmButtonText : "OK",
                                    cancelButtonText  : "",
                                    closeOnConfirm    : true,
                                    closeOnCancel     : false 
                                }
                            );
                        }
                    }
                });
            }
            else{
                swal(
                    {
                        title: "PURCHASE INVALID",
                        text : 'Select customer and product before purchasing!',
                        type : "error",
                        showCancelButton  : false,
                        confirmButtonColor: "#F27474",
                        confirmButtonText : "OK",
                        cancelButtonText  : "",
                        closeOnConfirm    : true,
                        closeOnCancel     : false 
                    }
                );
            }
        })

        // load();

        // function load(){
        //     $('input[type="text"]').val('');
    })
</script>